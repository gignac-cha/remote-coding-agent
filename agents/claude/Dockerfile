# Use the latest Ubuntu as the base image
FROM ubuntu:latest

# Avoid interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# Install base system dependencies
RUN apt update && apt install -y \
    git \
    curl \
    ca-certificates \
    jq \
    sudo \
    && rm -rf /var/lib/apt/lists/*

# Install GitHub CLI (gh)
RUN curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
    && chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
    && apt update \
    && apt install -y gh

# Grant passwordless sudo to the default ubuntu user
RUN echo "ubuntu ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Switch to the ubuntu user
USER ubuntu
WORKDIR /home/ubuntu

# Install nvm, Node.js v24, and the claude-code CLI
ENV NVM_DIR=/home/ubuntu/.nvm
ENV NODE_VERSION=24
RUN curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash && \
    . "$NVM_DIR/nvm.sh" && \
    nvm install $NODE_VERSION && \
    nvm alias default $NODE_VERSION && \
    nvm use default && \
    npm install -g @anthropic-ai/claude-code

# Add nvm to the PATH for subsequent shell sessions
ENV PATH="$NVM_DIR/versions/node/v$NODE_VERSION/bin:$PATH"

# Copy project files into the /app directory
WORKDIR /app
COPY --chown=ubuntu:ubuntu entrypoint.sh .
COPY --chown=ubuntu:ubuntu BASE_CLAUDE.md .
COPY --chown=ubuntu:ubuntu BASE_claude_settings.json .
COPY --chown=ubuntu:ubuntu upsert-gitignore.js .
COPY --chown=ubuntu:ubuntu json-stream-parser.js .
RUN sudo chmod +x ./entrypoint.sh

# Set the entrypoint script
ENTRYPOINT ["./entrypoint.sh"]

# Generated by Gemini